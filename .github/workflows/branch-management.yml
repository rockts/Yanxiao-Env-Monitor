name: Branch Management CI/CD

on:
 push:
  branches: [dev, master]
 pull_request:
  branches: [master]

jobs:
 # Devåˆ†æ”¯çš„æŒç»­é›†æˆ
 dev-ci:
  if: github.ref == 'refs/heads/dev'
  runs-on: ubuntu-latest

  steps:
   - uses: actions/checkout@v3

   - name: Set up Python
     uses: actions/setup-python@v3
     with:
      python-version: '3.11'

   - name: Install dependencies
     run: |
      python -m pip install --upgrade pip
      if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

   - name: Run Python syntax check
     run: |
      # æ£€æŸ¥Pythonæ–‡ä»¶è¯­æ³•
      find . -name "*.py" -exec python -m py_compile {} \;

   - name: Run basic tests
     run: |
      # è¿è¡ŒåŸºç¡€æµ‹è¯•
      echo "Running dev branch tests..."
      # è¿™é‡Œå¯ä»¥æ·»åŠ å…·ä½“çš„æµ‹è¯•å‘½ä»¤

   - name: Check for sensitive information
     run: |
      # æ£€æŸ¥æ•æ„Ÿä¿¡æ¯
      if grep -r -i "password\|secret\|token\|api_key" --include="*.py" --include="*.js" .; then
        echo "Warning: Possible sensitive information found"
        exit 1
      fi

   - name: Notify dev branch status
     run: |
      echo "âœ… Dev branch CI passed"

 # Masteråˆ†æ”¯çš„ç”Ÿäº§éƒ¨ç½²
 master-cd:
  if: github.ref == 'refs/heads/master'
  runs-on: ubuntu-latest

  steps:
   - uses: actions/checkout@v3

   - name: Set up Python
     uses: actions/setup-python@v3
     with:
      python-version: '3.11'

   - name: Install dependencies
     run: |
      python -m pip install --upgrade pip
      if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

   - name: Run production tests
     run: |
      # è¿è¡Œç”Ÿäº§ç¯å¢ƒæµ‹è¯•
      echo "Running production tests..."
      find . -name "*.py" -exec python -m py_compile {} \;

   - name: Security scan
     run: |
      # å®‰å…¨æ‰«æ
      echo "Running security scan..."
      if grep -r -i "password\|secret\|token\|api_key" --include="*.py" --include="*.js" .; then
        echo "âŒ Security scan failed: sensitive information found"
        exit 1
      fi

   - name: Create deployment artifact
     run: |
      # åˆ›å»ºéƒ¨ç½²åŒ…
      echo "Creating deployment artifact..."
      tar -czf deployment.tar.gz --exclude='.git' --exclude='env' --exclude='__pycache__' .

   - name: Deploy to production (simulate)
     run: |
      # æ¨¡æ‹Ÿç”Ÿäº§éƒ¨ç½²
      echo "ğŸš€ Deploying to production..."
      echo "Deployment completed successfully"

   - name: Notify production deployment
     run: |
      echo "âœ… Production deployment completed"

 # Pull Requestæ£€æŸ¥
 pr-check:
  if: github.event_name == 'pull_request'
  runs-on: ubuntu-latest

  steps:
   - uses: actions/checkout@v3

   - name: Set up Python
     uses: actions/setup-python@v3
     with:
      python-version: '3.11'

   - name: Install dependencies
     run: |
      python -m pip install --upgrade pip
      if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

   - name: Check PR requirements
     run: |
      echo "Checking PR requirements..."

      # æ£€æŸ¥æäº¤ä¿¡æ¯æ ¼å¼
      git log --format="%s" -n 1 | grep -E "^(feat|fix|docs|style|refactor|test|chore)(\(.+\))?: .+"

      # æ£€æŸ¥Pythonè¯­æ³•
      find . -name "*.py" -exec python -m py_compile {} \;

      # æ£€æŸ¥åˆ†æ”¯ç­–ç•¥
      if [ "${{ github.base_ref }}" == "master" ] && [ "${{ github.head_ref }}" != "dev" ]; then
        echo "âŒ Only dev branch can be merged into master"
        exit 1
      fi

   - name: Code quality check
     run: |
      echo "Running code quality checks..."
      # è¿™é‡Œå¯ä»¥æ·»åŠ ä»£ç è´¨é‡æ£€æŸ¥å·¥å…·
      echo "âœ… Code quality check passed"

   - name: Notify PR status
     run: |
      echo "âœ… PR checks completed"

 # å®šæœŸåˆ†æ”¯å¥åº·æ£€æŸ¥
 branch-health-check:
  if: github.event_name == 'schedule'
  runs-on: ubuntu-latest

  steps:
   - uses: actions/checkout@v3
     with:
      fetch-depth: 0 # è·å–å®Œæ•´å†å²

   - name: Check branch divergence
     run: |
      git fetch origin

      # æ£€æŸ¥åˆ†æ”¯åˆ†æ­§
      dev_ahead=$(git rev-list --count origin/master..origin/dev)
      dev_behind=$(git rev-list --count origin/dev..origin/master)

      echo "Dev branch is $dev_ahead commits ahead of master"
      echo "Dev branch is $dev_behind commits behind master"

      # å¦‚æœåˆ†æ­§è¿‡å¤§ï¼Œå‘å‡ºè­¦å‘Š
      if [ $dev_behind -gt 10 ]; then
        echo "âš ï¸ Warning: dev branch is significantly behind master"
      fi

      if [ $dev_ahead -gt 50 ]; then
        echo "âš ï¸ Warning: dev branch is significantly ahead of master"
      fi

   - name: Generate branch report
     run: |
      echo "ğŸ“Š Branch Health Report"
      echo "======================="
      git log --oneline --graph --decorate --all -10
