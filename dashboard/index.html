<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8" />
    <title>çƒŸé“ºå°å­¦æ™ºæ…§ç¯å¢ƒç›‘æµ‹ç‰©è”ç½‘</title>
    <meta name="viewport" content="width=1920, initial-scale=1.0" />
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/echarts/dist/echarts.min.js"></script>
    <script src="https://unpkg.com/element-plus/dist/index.full.js"></script>
    <script src="https://unpkg.com/@element-plus/icons-vue/dist/index.iife.min.js"></script>
    <script src="https://unpkg.com/particles.js"></script>
    <!-- å¼•å…¥Iconify CDN -->
    <script src="https://code.iconify.design/3/3.1.1/iconify.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css" />
    <style>
        /* é’ˆå¯¹1920Ã—1080æ˜¾ç¤ºå™¨ä¼˜åŒ– */
        html,
        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
            font-family: 'Noto Sans SC', 'PingFang SC', sans-serif;
            background: radial-gradient(circle at top left, #0d1a2d, #0a1220);
            color: #fff;
            overflow: hidden;
            zoom: 1.0;
            /* å›ºå®šç¼©æ”¾æ¯”ä¾‹ */
        }



        /* ä¼˜åŒ–æ ‡é¢˜åŒºåŸŸé«˜åº¦ - é’ˆå¯¹1920Ã—1080 */
        .header-title {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 80px;
            /* å›ºå®šé«˜åº¦ */
            margin-bottom: 0;
            gap: 20px;
            max-width: 100vw;
            overflow: hidden;
            padding: 0 10px;
            box-sizing: border-box;
        }

        .header-title .main-title {
            display: flex;
            align-items: center;
            font-size: 42px;
            /* å›ºå®šå­—ä½“å¤§å° */
            font-weight: bold;
            color: #ffffff;
            min-width: 200px;
            flex-shrink: 0;
            padding-top: 8px;
        }

        .header-title .main-title img {
            height: 70px;
            /* å›ºå®šå›¾ç‰‡å¤§å° */
            vertical-align: middle;
            margin-right: 12px;
        }

        /* ä¼˜åŒ–dashboardç½‘æ ¼å¸ƒå±€ - é’ˆå¯¹1920Ã—1080 */
        .dashboard {
            display: grid;
            grid-template-columns: 0.75fr 2.8fr 1.1fr;
            grid-template-rows: 1fr;
            height: calc(100vh - 90px);
            /* å›ºå®šé«˜åº¦è®¡ç®— */
            padding: 10px;
            /* å›ºå®šå†…è¾¹è· */
            margin: 5px auto;
            gap: 8px;
            /* å›ºå®šé—´è· */
            max-width: 100vw;
            overflow: hidden;
            box-sizing: border-box;
        }

        /* ä¼˜åŒ–å¡ç‰‡æ ·å¼ */
        .card {
            border-radius: 12px;
            padding: 10px;
            background-color: rgba(4, 47, 82, 0.95);
            backdrop-filter: blur(3px);
            overflow: hidden;
            margin-bottom: 5px;
        }

        /* ä¼˜åŒ–å·¦æ ç¯å¢ƒæ•°æ®æ˜¾ç¤º */
        .date-block {
            display: flex;
            height: 65px;
            /* å›ºå®šé«˜åº¦ */
            align-items: center;
            justify-content: space-between;
            padding: 4px 8px;
        }

        .date-label {
            display: flex;
            align-items: center;
            font-size: 16px;
            /* å›ºå®šå­—ä½“ */
            color: #fff;
            gap: 8px;
            font-weight: bold;
        }

        .date-value {
            font-size: 24px;
            /* å›ºå®šå­—ä½“ */
            color: #fff200c6;
            font-weight: bold;
            margin-right: 4px;
        }

        .date-unit {
            font-size: 14px;
            /* å›ºå®šå­—ä½“ */
            color: #e0f7fa;
            margin-left: 2px;
        }

        /* ä¼˜åŒ–ä»ªè¡¨ç›˜å°ºå¯¸ - é’ˆå¯¹1920Ã—1080 */
        .gauge-chart {
            width: 200px;
            /* å›ºå®šå°ºå¯¸ */
            height: 200px;
            margin: 3px;
        }

        .gauge-row {
            display: flex;
            justify-content: space-around;
            gap: 15px;

            margin: 5px 0;
        }

        /* ä¼˜åŒ–è§†é¢‘ç›‘æ§åŒºåŸŸ - é’ˆå¯¹1920Ã—1080 */
        .video-wrapper {
            position: relative;
            width: 100%;
            height: 420px;
            /* å›ºå®šé«˜åº¦ */
            border-radius: 12px;
            overflow: hidden;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* ä¼˜åŒ–å›¾è¡¨é«˜åº¦ - é’ˆå¯¹1920Ã—1080 */
        .chart {
            width: 100%;
            height: 220px;
            /* å›ºå®šé«˜åº¦ */
            margin: 6px 0;
        }

        /* MQTTçŠ¶æ€ç§»åˆ°å³ä¸‹è§’ - æ›´æ–°æ ·å¼ */
        .mqtt-status-fixed {
            position: fixed;
            right: 20px;
            bottom: 10px;
            z-index: 999;
            background: rgba(0, 0, 0, 0.85);
            padding: 10px 10px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .mqtt-status-fixed:hover {
            background: rgba(0, 0, 0, 0.9);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
        }

        .mqtt-status-label {
            color: #aaa;
            font-size: 14px;
        }

        .mqtt-status-value {
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: color 0.3s;
        }

        /* è¿æ¥çŠ¶æ€çš„é¢œè‰² */
        .mqtt-connected {
            color: #4caf50;
        }

        .mqtt-disconnected {
            color: #ff5252;
        }

        .mqtt-connecting {
            color: #aaa;
        }

        /* ç‰ˆæƒä¿¡æ¯ç§»åˆ°å·¦ä¸‹è§’ */
        .copyright {
            position: fixed;
            left: 20px;
            bottom: 10px;
            z-index: 999;
            font-size: 16px;
            color: #ffeaea;
            letter-spacing: 1px;
            background: rgba(0, 0, 0, 0.6);
            padding: 5px 10px;
            border-radius: 5px;
        }

        .header-info-bar {
            margin-top: 4px;
            font-size: 16px;
            /* ä»14pxå¢åŠ åˆ°16px */
            color: #fff;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 12px;
        }

        /* ä¼˜åŒ–flex-columné—´è· */
        .dashboard .flex-column {
            gap: 8px !important;
            /* ä»10pxå‡å°‘åˆ°8px */
        }

        /* ä¼˜åŒ–AIå»ºè®®åŒºåŸŸ - ä½¿ç”¨å“åº”å¼è®¾è®¡ */
        .ai-suggestion-html {
            margin: 0 5px;
            color: #fff;
            text-align: left;
            font-size: clamp(14px, 1.2vw, 16px);
            /* å“åº”å¼å­—ä½“ */
            line-height: 1.4;
            word-break: break-all;
            padding: 5px;
            box-sizing: border-box;
            min-height: clamp(40px, 4vh, 45px);
            /* å“åº”å¼é«˜åº¦ */
            background: rgba(0, 0, 0, 0.10);
            border-radius: 8px;
        }

        /* ä¼˜åŒ–ä»ªè¡¨ç›˜æ ‡ç­¾ - ä½¿ç”¨å“åº”å¼è®¾è®¡ */
        .gauge-title {
            font-size: clamp(16px, 1.4vw, 18px);
            /* å“åº”å¼å­—ä½“ */
            font-weight: bold;
            color: #fff;
            margin-bottom: 3px;
        }

        .gauge-level {
            font-size: clamp(14px, 1.2vw, 16px);
            /* å“åº”å¼å­—ä½“ */
            font-weight: 500;
        }

        /* ä¼˜åŒ–æ—¥æœŸæ—¶é—´æ˜¾ç¤º - ä½¿ç”¨å“åº”å¼å­—ä½“ */
        .datetime {
            font-size: clamp(16px, 1.5vw, 18px);
            color: #00eaff;
            font-weight: 500;
        }
    </style>
</head>


<body>
    <div id="particles-js"></div>

    <div id="app">
        <div class="header-title">
            <div class="main-title">
                <img src="./frontend/assets/img/logo_white.png" alt="logo"
                    style="height: 80px; vertical-align: middle; margin-right: 12px;">
                çƒŸé“ºå°å­¦æ™ºæ…§ç¯å¢ƒç›‘æµ‹ç‰©è”ç½‘
            </div>
            <div class="datetime">
                <i class="el-icon-date" style="color:#00eaff;margin-right:5px;"></i>{{ dateStr }} {{ now }}
            </div>
        </div>

        <div class="dashboard">
            <!-- å·¦æ ï¼šç¯å¢ƒæ•°æ®å¡ç‰‡ -->
            <div class="flex-column">
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <div class="card">
                        <div class="date-block">
                            <span class="date-label"><span class="iconify" data-icon="mdi:thermometer-lines"
                                    style="font-size:32px;color:#ff7043;"></span>å®¤å¤–æ¸©åº¦</span>
                            <span><span class="date-value">{{ formatInt(data.outdoor_temp) }}</span><span
                                    class="date-unit">â„ƒ</span></span>
                        </div>
                    </div>
                    <div class="card">
                        <div class="date-block">
                            <span class="date-label"><span class="iconify" data-icon="mdi:blur"
                                    style="font-size:32px;color:#bdbdbd;"></span>PM2.5</span>
                            <span><span class="date-value">{{ formatInt(data.pm25) }}</span><span
                                    class="date-unit">Î¼g/mÂ³</span></span>
                        </div>
                    </div>
                    <div class="card">
                        <div class="date-block">
                            <span class="date-label"><span class="iconify" data-icon="mdi:weather-partly-cloudy"
                                    style="font-size:32px;color:#ffd700;"></span>å¤©æ°”</span>
                            <span><span class="date-value">{{ data.weather }}</span></span>
                        </div>
                    </div>
                    <div class="card">
                        <div class="date-block">
                            <span class="date-label"><span class="iconify" data-icon="mdi:compass"
                                    style="font-size:32px;color:#00eaff;"></span>é£å‘</span>
                            <span><span class="date-value">{{ data.wind_dir }}</span></span>
                        </div>
                    </div>
                    <div class=" card">
                        <div class="date-block">
                            <span class="date-label"><span class="iconify" data-icon="mdi:thermometer"
                                    style="font-size:32px;color:#ff7043;"></span>å®¤å†…æ¸©åº¦</span>
                            <span><span class="date-value">{{ formatInt(data.temperature) }}</span><span
                                    class="date-unit">â„ƒ</span></span>
                        </div>
                    </div>
                    <div class="card">
                        <div class="date-block">
                            <span class="date-label"><span class="iconify" data-icon="mdi:water-percent"
                                    style="font-size:32px;color:#42a5f5;"></span>å®¤å†…æ¹¿åº¦</span>
                            <span><span class="date-value">{{ formatInt(data.humidity) }}</span><span
                                    class="date-unit">%</span></span>
                        </div>
                    </div>
                    <div class="card">
                        <div class="date-block">
                            <span class="date-label"><span class="iconify" data-icon="mdi:weather-sunny-alert"
                                    style="font-size:32px;color:#ffd600;"></span>ç´«å¤–çº¿æŒ‡æ•°</span>
                            <span><span class="date-value">{{ formatInt(data.uv_raw) }}</span></span>
                        </div>
                    </div>
                    <div class="card">
                        <div class="date-block">
                            <span class="date-label"><span class="iconify" data-icon="mdi:volume-high"
                                    style="font-size:32px;color:#ffb300;"></span>å™ªéŸ³</span>
                            <span><span class="date-value">{{ formatInt(data.noise) }}</span><span
                                    class="date-unit">dBA</span></span>
                        </div>
                    </div>
                    <!-- mqttçŠ¶æ€å’Œç‰ˆæœ¬ä¿¡æ¯ä¿ç•™åœ¨ä¸‹æ–¹ -->
                    <div class="mqtt-status-fixed">
                        <span style="font-size:16px;color:#aaa;">MQTTçŠ¶æ€:</span>
                        <span
                            :style="{color: mqttStatus==='å·²è¿æ¥' ? '#4caf50' : (mqttStatus.startsWith('æœªè¿æ¥') ? '#ff5252' : '#aaa'),fontWeight:'bold',marginLeft:'6px',display:'flex',alignItems:'center',transition:'color 0.3s'}">
                            <el-icon v-if="mqttStatus==='å·²è¿æ¥'">
                                <component :is="CircleCheckFilled" />
                            </el-icon>
                            <el-icon v-else-if="mqttStatus.startsWith('æœªè¿æ¥')">
                                <component :is="WarningFilled" />
                            </el-icon>
                            <el-icon v-else style="color:#aaa;font-size:20px;margin-right:4px;">
                                <component :is="Loading" />
                            </el-icon>
                            {{ mqttStatus }}
                        </span>
                        <!-- é…ç½®æŒ‰é’® -->
                        <el-button @click="showServerConfig = true" size="small"
                            style="margin-left: 10px; background: rgba(255,255,255,0.1); border: none; color: #aaa;">
                            <el-icon>
                                <component :is="Setting" />
                            </el-icon>
                        </el-button>
                    </div>
                    <div class="copyright">
                        Powered by çƒŸé“ºå°å­¦æ™ºæ…§ç¯å¢ƒç›‘æµ‹ç‰©è”ç½‘ &copy; 2025 | Copilotå‰ç«¯ä¼˜åŒ–ç‰ˆ
                    </div>
                </div>
            </div>

            <!-- ä¸­æ ï¼šè§†é¢‘ç›‘æ§å’ŒAIå»ºè®® + 4ä¸ªç­‰çº§ä»ªè¡¨ç›˜ -->
            <div class="flex-column">
                <!-- ç¬¬ä¸€è¡Œï¼šè§†é¢‘ç›‘æ§å’ŒAIå»ºè®® -->
                <div style="display: flex; gap: 12px; flex: 0 0 auto;">
                    <div class="card" style="flex: 1 1 0;">
                        <div style="display: flex; flex-direction: column; height: 100%;">
                            <div
                                style="flex: 1 1 0; display: flex; flex-direction: column; gap: 12px; padding: 16px 12px;">
                                <div class="video-wrapper" style="position: relative;">
                                    <!-- è§†é¢‘æ ‡é¢˜æ”¾åœ¨è§†é¢‘æ¡†å†… -->
                                    <div
                                        style="position: absolute; top: 10px; left: 15px; z-index: 3; background: rgba(0,0,0,0.7); padding: 5px 10px; border-radius: 5px;">
                                        <span style="font-size: 16px; color: #fff; font-weight: bold;">è§†é¢‘ç›‘æ§</span>
                                    </div>

                                    <!-- MJPEGæµè§†é¢‘ -->
                                    <img v-if="data.camera && data.camera.includes('mjpeg')" :src="data.camera"
                                        alt="å®æ—¶è§†é¢‘æµ"
                                        style="width: 100%; height: 100%; object-fit: cover; border-radius: 14px;"
                                        @error="handleVideoError" @load="handleVideoLoad">

                                    <!-- é™æ€å›¾ç‰‡å®šæ—¶åˆ·æ–° -->
                                    <img v-else-if="data.camera && (data.camera.startsWith('http') || data.camera.startsWith('data:image'))"
                                        :src="cameraUrlWithTimestamp" :key="refreshTimestamp" alt="æ‘„åƒå¤´å¿«ç…§"
                                        style="width: 100%; height: 100%; object-fit: cover; border-radius: 14px;"
                                        @error="handleImageError" @load="handleImageLoad">

                                    <!-- æ— è§†é¢‘ä¿¡å· -->
                                    <div v-else
                                        style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                                        <span class="iconify" data-icon="mdi:video-off"
                                            style="font-size: 80px; color: #666;"></span>
                                        <div style="color: #aaa; margin-top: 10px; font-size: 14px;">
                                            æš‚æ— è§†é¢‘ä¿¡å·
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card" style="flex: 1 1 0;">
                        <div class="header-info-bar">
                            <div
                                style="display: flex; align-items: center; gap: 8px; justify-content: space-between; width: 100%;">
                                <span style="font-size: 18px; color: #fff; font-weight: bold;">AIå»ºè®®</span>
                                <el-button @click="refreshAISuggestion" size="small"
                                    style="background: rgba(255,255,255,0.1); border: none; color: #aaa; padding: 4px 8px;"
                                    :loading="aiRefreshing">
                                    <el-icon>
                                        <component :is="Refresh" />
                                    </el-icon>
                                </el-button>
                            </div>
                        </div>
                        <div style="padding: 12px 10px; display: flex; flex-direction: column; gap: 15px;">
                            <!-- å®¤å†…å»ºè®® -->
                            <div>
                                <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                    <span class="iconify" data-icon="mdi:home"
                                        style="font-size: 18px; color: #4fc3f7; margin-right: 6px;"></span>
                                    <span style="font-size: 14px; font-weight: bold; color: #4fc3f7;">å®¤å†…ç¯å¢ƒå»ºè®®</span>
                                </div>
                                <div class="ai-suggestion-html" v-html="data.suggestionIndoorHtml"
                                    style="min-height: 50px;">
                                    {{ data.suggestionIndoor }}
                                </div>
                            </div>
                            <!-- å®¤å¤–å»ºè®® -->
                            <div>
                                <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                    <span class="iconify" data-icon="mdi:weather-partly-cloudy"
                                        style="font-size: 18px; color: #66bb6a; margin-right: 6px;"></span>
                                    <span style="font-size: 14px; font-weight: bold; color: #66bb6a;">å®¤å¤–ç¯å¢ƒå»ºè®®</span>
                                </div>
                                <div class="ai-suggestion-html" v-html="data.suggestionOutdoorHtml"
                                    style="min-height: 50px;">
                                    {{ data.suggestionOutdoor }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ç¬¬äºŒè¡Œï¼š4ä¸ªç­‰çº§ä»ªè¡¨ç›˜ï¼ˆä¸€è¡Œæ’åˆ—ï¼‰+ æ•°æ®åç§°å’Œç­‰çº§ -->
                <div class="card" style="flex: 0 0 auto;">
                    <div class="header-info-bar">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 18px; color: #fff; font-weight: bold;">ç©ºæ°”è´¨é‡</span>
                        </div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 12px; padding: 16px 12px;">
                        <div class="gauge-row" style="display: flex; justify-content: space-around; gap: 18px;">
                            <!-- AQIä»ªè¡¨ç›˜ -->
                            <div style="display: flex; flex-direction: column; align-items: center;">
                                <div class="gauge-chart" ref="aqiGauge"></div>
                                <div style="text-align: center; ">
                                    <div style="font-size: 16px; font-weight: bold; color: #fff; margin-bottom: 4px;">
                                        AQI
                                    </div>
                                    <div style="font-size: 14px; color: #4fc3f7;">{{ aqiLevelText }}</div>
                                </div>
                            </div>

                            <!-- UVä»ªè¡¨ç›˜ -->
                            <div style="display: flex; flex-direction: column; align-items: center;">
                                <div class="gauge-chart" ref="uvGauge"></div>
                                <div style="text-align: center; ">
                                    <div style="font-size: 16px; font-weight: bold; color: #fff; margin-bottom: 4px;">
                                        ç´«å¤–çº¿
                                    </div>
                                    <div style="font-size: 14px; color: #66bb6a;">{{ uvLevelText }}</div>
                                </div>
                            </div>

                            <!-- eCOâ‚‚ä»ªè¡¨ç›˜ -->
                            <div style="display: flex; flex-direction: column; align-items: center;">
                                <div class="gauge-chart" ref="eco2Gauge"></div>
                                <div style="text-align: center; ">
                                    <div style="font-size: 16px; font-weight: bold; color: #fff; margin-bottom: 4px;">
                                        eCOâ‚‚
                                    </div>
                                    <div style="font-size: 14px; color: #ffb74d;">{{ eco2LevelText }}</div>
                                </div>
                            </div>

                            <!-- TVOCä»ªè¡¨ç›˜ -->
                            <div style="display: flex; flex-direction: column; align-items: center;">
                                <div class="gauge-chart" ref="tvocGauge"></div>
                                <div style="text-align: center; ">
                                    <div style="font-size: 16px; font-weight: bold; color: #fff; margin-bottom: 4px;">
                                        TVOC
                                    </div>
                                    <div style="font-size: 14px; color: #f06292;">{{ tvocLevelText }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³æ ï¼š3ä¸ªæŠ˜çº¿ç»Ÿè®¡å›¾ -->
            <div class="flex-column">
                <div class="card" style="flex: 1 1 0;">
                    <div style="display: flex; flex-direction: column; height: 100%;">
                        <div style="flex: 0 0 auto;">
                            <div class="header-info-bar">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 18px; color: #fff; font-weight: bold;">ç¯å¢ƒæ•°æ®</span>
                                    <el-icon style="color: #00eaff; font-size: 22px;">
                                        <component :is="WarningFilled" />
                                    </el-icon>
                                    <span style="font-size: 14px; color: #aaa;">å®æ—¶ç›‘æµ‹</span>
                                </div>
                            </div>
                        </div>
                        <div style="flex: 1 1 0; display: flex; flex-direction: column; gap: 12px; padding: 16px 12px;">
                            <div class="chart" ref="tempChart"></div>
                            <div class="chart" ref="humiChart"></div>
                            <div class="chart" ref="noiseChart"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div> <!-- å…³é—­dashboard -->

        <!-- æœåŠ¡å™¨é…ç½®å¯¹è¯æ¡† -->
        <el-dialog v-model="showServerConfig" title="æœåŠ¡å™¨é…ç½®" width="400px" :modal="true" :close-on-click-modal="false">
            <div style="padding: 20px 0;">
                <p style="color: #666; margin-bottom: 20px; font-size: 14px;">
                    å½“å‰æœåŠ¡å™¨åœ°å€: <span style="color: #409eff; font-weight: bold;">{{ currentServerUrl }}</span>
                </p>
                <el-form :model="serverConfigForm" label-width="120px">
                    <el-form-item label="æœåŠ¡å™¨IPåœ°å€:">
                        <el-input v-model="serverConfigForm.serverIp" placeholder="ä¾‹å¦‚: 192.168.1.100" />
                        <div style="font-size: 12px; color: #999; margin-top: 5px;">
                            ç•™ç©ºåˆ™ä½¿ç”¨å½“å‰ä¸»æœºåœ°å€ï¼Œç«¯å£å›ºå®šä¸º5052
                        </div>
                    </el-form-item>
                </el-form>
            </div>
            <template #footer>
                <span class="dialog-footer">
                    <el-button @click="showServerConfig = false">å–æ¶ˆ</el-button>
                    <el-button type="primary" @click="saveServerConfig">ä¿å­˜å¹¶é‡æ–°åŠ è½½</el-button>
                </span>
            </template>
        </el-dialog>

    </div> <!-- å…³é—­app -->
    <script>
        const { createApp, onMounted, ref } = Vue;
        createApp({
            setup() {
                const now = ref('');
                const data = Vue.reactive({
                    temperature: '-', humidity: '-', aqi: 0, eco2: '-', tvoc: '-',
                    uv_raw: '-', uv_index: 0, noise: '-', camera: '',
                    suggestion: 'è·å–ä¸­...', suggestionHtml: '',
                    suggestionIndoor: 'è·å–ä¸­...', suggestionIndoorHtml: '',
                    suggestionOutdoor: 'è·å–ä¸­...', suggestionOutdoorHtml: '',
                    weather: '-', wind_dir: '-',
                    outdoor_temp: '-', pm25: '-',
                    cameras: ['', '', '', ''] // æ–°å¢4è·¯ç›‘æ§
                });
                const weekMap = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
                const dateStr = ref('');
                const aiRefreshing = ref(false); // AIå»ºè®®åˆ·æ–°çŠ¶æ€
                const updateDateStr = () => {
                    const nowDate = new Date();
                    dateStr.value = `${nowDate.getFullYear()}å¹´${nowDate.getMonth() + 1}æœˆ${nowDate.getDate()}æ—¥ æ˜ŸæœŸ${weekMap[nowDate.getDay()]}`;
                    now.value = nowDate.toLocaleTimeString('zh-CN', { hour12: false });
                };
                setInterval(updateDateStr, 1000);
                updateDateStr();
                const mqttStatus = ref('è¿æ¥ä¸­...');

                // æœåŠ¡å™¨åœ°å€é…ç½® - æ”¯æŒå±€åŸŸç½‘è®¿é—®
                const getServerUrl = () => {
                    console.log('ğŸŒ å¼€å§‹æœåŠ¡å™¨åœ°å€æ£€æµ‹...');

                    // æ£€æŸ¥URLå‚æ•°ä¸­æ˜¯å¦æŒ‡å®šäº†æœåŠ¡å™¨åœ°å€
                    const urlParams = new URLSearchParams(window.location.search);
                    const serverParam = urlParams.get('server');
                    if (serverParam) {
                        console.log('ğŸ“ æ£€æµ‹åˆ°URLå‚æ•°server:', serverParam);
                        return `http://${serverParam}:5052`;
                    }

                    // ä»localStorageè¯»å–ä¿å­˜çš„æœåŠ¡å™¨åœ°å€
                    const savedServer = localStorage.getItem('env-monitor-server');
                    if (savedServer) {
                        console.log('ğŸ’¾ æ£€æµ‹åˆ°localStorageä¿å­˜çš„æœåŠ¡å™¨:', savedServer);
                        return `http://${savedServer}:5052`;
                    }

                    // æ£€æµ‹å½“å‰è®¿é—®æ–¹å¼
                    const currentHost = window.location.hostname;
                    const currentPort = window.location.port;

                    console.log('ğŸ” å½“å‰è®¿é—®ä¿¡æ¯:');
                    console.log('  - hostname:', currentHost);
                    console.log('  - port:', `"${currentPort}"`);
                    console.log('  - port type:', typeof currentPort);

                    // å¦‚æœé€šè¿‡3000ç«¯å£è®¿é—®ï¼ˆå¤–ç½‘ç«¯å£è½¬å‘ï¼‰ï¼Œåˆ™ä½¿ç”¨3000ç«¯å£
                    if (currentPort === '3000') {
                        console.log('âœ… ç«¯å£åŒ¹é…3000ï¼Œä½¿ç”¨3000ç«¯å£');
                        return `http://${currentHost}:3000`;
                    }

                    // é»˜è®¤ä½¿ç”¨å½“å‰ä¸»æœºåœ°å€+5052ç«¯å£
                    console.log('ğŸ“ ç«¯å£ä¸åŒ¹é…3000ï¼Œä½¿ç”¨é»˜è®¤5052ç«¯å£');
                    return `http://${currentHost}:5052`;
                };

                const serverUrl = getServerUrl();
                console.log('ğŸ”§ è°ƒè¯•ä¿¡æ¯ï¼š');
                console.log('  - å½“å‰ä¸»æœºå:', window.location.hostname);
                console.log('  - å½“å‰ç«¯å£:', window.location.port);
                console.log('  - ç«¯å£ç±»å‹:', typeof window.location.port);
                console.log('  - ç«¯å£===3000?', window.location.port === '3000');
                console.log('  - æœ€ç»ˆæœåŠ¡å™¨åœ°å€:', serverUrl);

                // MQTTçŠ¶æ€æ£€æµ‹å‡½æ•°
                const checkMqttStatus = async () => {
                    try {
                        console.log('ğŸ” MQTTçŠ¶æ€æ£€æµ‹ - è¯·æ±‚åœ°å€:', `${serverUrl}/api/status`);
                        const res = await axios.get(`${serverUrl}/api/status`, { timeout: 2000 });
                        console.log('ğŸ“¡ MQTT APIå“åº”:', res.data);

                        if (res.data && res.data.mqtt_connected === true) {
                            mqttStatus.value = 'å·²è¿æ¥';
                            console.log('âœ… MQTTçŠ¶æ€æ›´æ–°: å·²è¿æ¥');
                        } else {
                            mqttStatus.value = 'æœªè¿æ¥';
                            console.log('âŒ MQTTçŠ¶æ€æ›´æ–°: æœªè¿æ¥');
                        }
                    } catch (e) {
                        console.log('âŒ MQTTçŠ¶æ€æ£€æµ‹å¤±è´¥:', e.message);
                        mqttStatus.value = 'æœªè¿æ¥';
                    }
                };

                // ç«‹å³æ‰§è¡Œä¸€æ¬¡MQTTçŠ¶æ€æ£€æµ‹
                checkMqttStatus();

                // å®šæ—¶è·å–MQTTè¿æ¥çŠ¶æ€
                setInterval(checkMqttStatus, 3000);

                const tempChart = ref(null);
                const humiChart = ref(null);
                const noiseChart = ref(null);
                const aqiGauge = ref(null);
                const uvGauge = ref(null);
                const eco2Gauge = ref(null);
                const tvocGauge = ref(null);


                // ä»ªè¡¨ç›˜ç¾åŒ–é…ç½®
                const renderGauges = () => {
                    // AQI é…è‰²ä¸ç­‰çº§ï¼ˆ5çº§ï¼šè“ã€ç»¿ã€é»„ã€æ©™ã€çº¢ï¼‰
                    let aqiColor = '#3498ff', aqiLevel = 1, aqiValue = Number(data.aqi);
                    if (aqiValue > 4) { aqiColor = '#ff3b30'; aqiLevel = 5; }
                    else if (aqiValue > 3) { aqiColor = '#ff9500'; aqiLevel = 4; }
                    else if (aqiValue > 2) { aqiColor = '#ffd600'; aqiLevel = 3; }
                    else if (aqiValue > 1) { aqiColor = '#34c759'; aqiLevel = 2; }
                    else { aqiColor = '#3498ff'; aqiLevel = 1; }
                    echarts.init(aqiGauge.value).setOption({
                        series: [{
                            type: 'gauge',
                            startAngle: 180,
                            endAngle: 0,
                            min: 1,
                            max: 5,
                            splitNumber: 4,
                            axisLine: {
                                lineStyle: {
                                    width: 6,
                                    color: [
                                        [0.2, '#3498ff'], // è“
                                        [0.4, '#34c759'], // ç»¿
                                        [0.6, '#ffd600'], // é»„
                                        [0.8, '#ff9500'], // æ©™
                                        [1, '#ff3b30']  // çº¢
                                    ]
                                }
                            },
                            pointer: {
                                icon: 'path://M12.8,0.7l12,40.1H0.7L12.8,0.7z', // é’ˆå°–åœ¨(0,0)ï¼ŒæŒ‡å‘æ•°æ®
                                length: '20%',
                                width: 20,
                                offsetCenter: [0, '-20%'],
                                itemStyle: { color: 'auto' }
                            },
                            axisTick: {
                                length: 12,
                                lineStyle: {
                                    color: 'auto',
                                    width: 2
                                }
                            },
                            splitLine: {
                                length: 20,
                                lineStyle: {
                                    color: 'auto',
                                    width: 5
                                }
                            },
                            axisLabel: {
                                distance: -60,
                                color: '#999',
                                fontSize: 18,
                                formatter: function (value) {
                                    const map = { 1: 'éå¸¸å¥½', 2: 'å¥½', 3: 'ä¸€èˆ¬', 4: 'å·®', 5: 'æå·®' };
                                    return map[value] || value;
                                }
                            },
                            title: { offsetCenter: [0, '-10%'], fontSize: 20, text: 'AQI' },
                            detail: {
                                valueAnimation: true,
                                fontSize: 30,
                                color: aqiColor,
                                offsetCenter: [0, '35%'],
                                formatter: function (v) { return aqiValue; }
                            },
                            data: [{ value: aqiValue }]
                        }]
                    });
                    // UV é…è‰²ä¸ç­‰çº§ï¼ˆ5çº§ï¼šè“ã€ç»¿ã€é»„ã€æ©™ã€çº¢ï¼‰
                    let uvColor = '#3498ff', uvValue = Number(data.uv_index), uvLevel = 0;
                    if (uvValue > 3) { uvColor = '#ff3b30'; uvLevel = 4; }
                    else if (uvValue > 2) { uvColor = '#ff9500'; uvLevel = 3; }
                    else if (uvValue > 1) { uvColor = '#ffd600'; uvLevel = 2; }
                    else if (uvValue > 0) { uvColor = '#34c759'; uvLevel = 1; }
                    else { uvColor = '#3498ff'; uvLevel = 0; }
                    echarts.init(uvGauge.value).setOption({
                        series: [{
                            type: 'gauge',
                            startAngle: 180,
                            endAngle: 0,
                            min: 0,
                            max: 4,
                            splitNumber: 4,
                            axisLine: {
                                lineStyle: {
                                    width: 6,
                                    color: [
                                        [0.2, '#3498ff'], // è“
                                        [0.4, '#34c759'], // ç»¿
                                        [0.6, '#ffd600'], // é»„
                                        [0.8, '#ff9500'], // æ©™
                                        [1, '#ff3b30']  // çº¢
                                    ]
                                }
                            },
                            pointer: {
                                icon: 'path://M12.8,0.7l12,40.1H0.7L12.8,0.7z', // é’ˆå°–åœ¨(0,0)ï¼ŒæŒ‡å‘æ•°æ®
                                length: '20%',
                                width: 20,
                                offsetCenter: [0, '-20%'],
                                itemStyle: { color: 'auto' }
                            },
                            axisTick: {
                                length: 12,
                                lineStyle: {
                                    color: 'auto',
                                    width: 2
                                }
                            },
                            splitLine: {
                                length: 20,
                                lineStyle: {
                                    color: 'auto',
                                    width: 5
                                }
                            },
                            axisLabel: {
                                distance: -60,
                                color: '#999',
                                fontSize: 18,
                                formatter: function (value) {
                                    const map = { 0: 'ä½', 1: 'ä¸­', 2: 'é«˜', 3: 'å¾ˆé«˜', 4: 'æé«˜' };
                                    return map[value] || value;
                                }
                            },
                            title: { show: true, offsetCenter: [0, '60%'], color: '#aaa', fontSize: 18, text: 'UV' },
                            detail: {
                                valueAnimation: true,
                                fontSize: 32,
                                color: uvColor,
                                offsetCenter: [0, '35%'],
                                formatter: function (v) { return uvValue; }
                            },
                            data: [{ value: uvValue }]
                        }]
                    });
                    // eCOâ‚‚ é…è‰²ä¸ç­‰çº§ï¼ˆ5çº§ï¼šè“ã€ç»¿ã€é»„ã€æ©™ã€çº¢ï¼‰
                    let eco2Color = '#3498ff', eco2Value = Number(data.eco2), eco2Level = 1;
                    if (eco2Value > 1500) { eco2Color = '#ff3b30'; eco2Level = 5; }
                    else if (eco2Value > 1000) { eco2Color = '#ff9500'; eco2Level = 4; }
                    else if (eco2Value > 800) { eco2Color = '#ffd600'; eco2Level = 3; }
                    else if (eco2Value > 600) { eco2Color = '#34c759'; eco2Level = 2; }
                    else { eco2Color = '#3498ff'; eco2Level = 1; }
                    echarts.init(eco2Gauge.value).setOption({
                        series: [{
                            type: 'gauge',
                            startAngle: 180,
                            endAngle: 0,
                            min: 400,
                            max: 1500,
                            splitNumber: 4,
                            axisLine: {
                                lineStyle: {
                                    width: 6,
                                    color: [
                                        [0.2, '#3498ff'], // è“
                                        [0.4, '#34c759'], // ç»¿
                                        [0.6, '#ffd600'], // é»„
                                        [0.8, '#ff9500'], // æ©™
                                        [1, '#ff3b30']  // çº¢
                                    ]
                                }
                            },
                            pointer: {
                                icon: 'path://M12.8,0.7l12,40.1H0.7L12.8,0.7z',

                                length: '20%',
                                width: 20,
                                offsetCenter: [0, '-20%'],
                                itemStyle: { color: 'auto' }
                            },
                            axisTick: {
                                length: 12,
                                lineStyle: {
                                    color: 'auto',
                                    width: 2
                                }
                            },
                            splitLine: {
                                length: 20,
                                lineStyle: {
                                    color: 'auto',
                                    width: 5
                                }
                            },
                            axisLabel: {
                                distance: -60,
                                color: '#999',
                                fontSize: 18,
                                formatter: function (value) {
                                    const map = { 400: 'éå¸¸å¥½', 600: 'å¥½', 800: 'ä¸€èˆ¬', 1000: 'å·®', 1500: 'ä¸¥é‡' };
                                    return map[value] || value;
                                }
                            },
                            title: { show: true, offsetCenter: [0, '60%'], color: '#aaa', fontSize: 18, text: 'eCOâ‚‚' },
                            detail: {
                                valueAnimation: true,
                                fontSize: 32,
                                color: eco2Color,
                                offsetCenter: [0, '35%'],
                                formatter: function (v) { return eco2Value; }
                            },
                            data: [{ value: eco2Value }]
                        }]
                    });
                    // TVOC é…è‰²ä¸ç­‰çº§ï¼ˆ4çº§ï¼šç»¿ã€é»„ã€æ©™ã€çº¢ï¼‰
                    let tvocColor = '#34c759', tvocValue = Number(data.tvoc), tvocLevel = 1;
                    if (tvocValue >= 6000) { tvocColor = '#ff3b30'; tvocLevel = 4; }
                    else if (tvocValue >= 750) { tvocColor = '#ff9500'; tvocLevel = 3; }
                    else if (tvocValue >= 50) { tvocColor = '#ffd600'; tvocLevel = 2; }
                    else { tvocColor = '#34c759'; tvocLevel = 1; }
                    echarts.init(tvocGauge.value).setOption({
                        series: [{
                            type: 'gauge',
                            startAngle: 180,
                            endAngle: 0,
                            min: 0,
                            max: 6000,
                            splitNumber: 4,
                            axisLine: {
                                lineStyle: {
                                    width: 6,
                                    color: [
                                        [0.25, '#34c759'], // ç»¿
                                        [0.5, '#ffd600'], // é»„
                                        [0.75, '#ff9500'], // æ©™
                                        [1, '#ff3b30']  // çº¢
                                    ]
                                }
                            },
                            pointer: {
                                icon: 'path://M12.8,0.7l12,40.1H0.7L12.8,0.7z', // é’ˆå°–åœ¨(0,0)ï¼ŒæŒ‡å‘æ•°æ®
                                length: '20%',
                                width: 20,
                                offsetCenter: [0, '-20%'],
                                itemStyle: { color: 'auto' }
                            },
                            axisTick: {
                                length: 12,
                                lineStyle: {
                                    color: 'auto',
                                    width: 2
                                }
                            },
                            splitLine: {
                                length: 20,
                                lineStyle: {
                                    color: 'auto',
                                    width: 5
                                }
                            },
                            axisLabel: {
                                distance: -60,
                                color: '#999',
                                fontSize: 18,
                                formatter: function (value) {
                                    const map = { 0: 'æ­£å¸¸', 50: 'ä¸€èˆ¬', 750: 'ä¸å¥½', 6000: 'ä¸¥é‡' };
                                    return map[value] || value;
                                }
                            },
                            title: { offsetCenter: [0, '60%'], color: '#aaa', fontSize: 18, text: 'TVOC' },
                            detail: {
                                valueAnimation: true,
                                fontSize: 32,
                                color: tvocColor,
                                offsetCenter: [0, '35%'],
                                formatter: function (v) { return tvocValue; }
                            },
                            data: [{ value: tvocValue }]
                        }]
                    });
                };
                const aqiLevelText = Vue.computed(() => {
                    const v = Number(data.aqi);
                    if (v <= 1) return 'éå¸¸å¥½';
                    if (v <= 2) return 'å¥½';
                    if (v <= 3) return 'ä¸€èˆ¬';
                    if (v <= 4) return 'å·®';
                    return 'æå·®';
                });
                const uvLevelText = Vue.computed(() => {
                    const v = Number(data.uv_index);
                    if (v <= 0) return 'ä½';
                    if (v <= 1) return 'ä¸­';
                    if (v <= 3) return 'é«˜';
                    if (v <= 4) return 'å¾ˆé«˜';
                    return 'æé«˜';
                });
                // eCOâ‚‚ç­‰çº§è½¬æ¢å‡½æ•°
                function getEco2Level(v) {
                    if (isNaN(v) || v === 400) return 0;
                    if (v <= 600) return 1;
                    if (v <= 800) return 2;
                    if (v <= 1000) return 3;
                    if (v <= 1500) return 4;
                    return 5;
                }
                // TVOCç­‰çº§è½¬æ¢å‡½æ•°
                function getTvocLevel(v) {
                    if (isNaN(v) || v === 0) return 0;
                    if (v < 50) return 1;
                    if (v < 750) return 2;
                    if (v < 6000) return 3;
                    return 4;
                }
                // æ—¶é—´è½´ç”Ÿæˆå‡½æ•°ï¼Œè¿”å›120ä¸ªæ¯ä¸¤åˆ†é’Ÿä¸€æ ¼çš„æ—¶é—´ç‚¹
                function getTimes() {
                    const now = new Date();
                    const times = [];
                    now.setSeconds(0, 0);
                    for (let i = 119; i >= 0; i--) {
                        const t = new Date(now.getTime() - i * 2 * 60 * 1000);
                        const h = t.getHours().toString().padStart(2, '0');
                        const m = t.getMinutes().toString().padStart(2, '0');
                        times.push(`${h}:${m}`);
                    }
                    return times;
                }
                const eco2LevelText = Vue.computed(() => {
                    const v = Number(data.eco2);
                    const level = getEco2Level(v);
                    switch (level) {
                        case 1: return 'éå¸¸å¥½';
                        case 2: return 'å¥½';
                        case 3: return 'ä¸€èˆ¬';
                        case 4: return 'å·®';
                        case 5: return 'ä¸¥é‡';
                        default: return '--';
                    }
                });
                const tvocLevelText = Vue.computed(() => {
                    const v = Number(data.tvoc);
                    const level = getTvocLevel(v);
                    switch (level) {
                        case 1: return 'æ­£å¸¸';
                        case 2: return 'ä¸€èˆ¬';
                        case 3: return 'å·®';
                        case 4: return 'ä¸¥é‡';
                        default: return '--';
                    }
                });


                // æŠ˜çº¿å›¾ç¾åŒ–é…ç½®
                const renderCharts = () => {
                    // ç”Ÿæˆ120ä¸ªåŠ¨æ€æ—¶é—´ç‚¹ï¼Œæ¯ä¸¤åˆ†é’Ÿä¸€æ ¼
                    const times = getTimes();
                    // ç”Ÿæˆ100ä¸ªéšæœºæ•°æ®
                    const tempDataRaw = Array.from({ length: 120 }, () => (20 + Math.random() * 5).toFixed(1));
                    const humiDataRaw = Array.from({ length: 120 }, () => (40 + Math.random() * 20).toFixed(1));
                    const noiseDataRaw = Array.from({ length: 120 }, () => (45 + Math.random() * 10).toFixed(1));

                    // æ»‘åŠ¨å¹³å‡å‡½æ•°ï¼Œwindow=5
                    function smooth(arr, win = 5) {
                        const res = [];
                        for (let i = 0; i < arr.length; i++) {
                            let s = 0, c = 0;
                            for (let j = Math.max(0, i - Math.floor(win / 2)); j <= Math.min(arr.length - 1, i + Math.floor(win / 2)); j++) {
                                s += Number(arr[j]); c++;
                            }
                            res.push((s / c).toFixed(2));
                        }
                        return res;
                    }
                    const tempData = smooth(tempDataRaw, 5);
                    const humiData = smooth(humiDataRaw, 5);
                    const noiseData = smooth(noiseDataRaw, 5);

                    // åŠ¨æ€è®¡ç®—yè½´èŒƒå›´ï¼Œç•™10%è¾¹è·
                    function getMinMax(arr, minLimit, maxLimit) {
                        const nums = arr.map(Number).filter(v => !isNaN(v));
                        if (!nums.length) return [minLimit, maxLimit];
                        let min = Math.min(...nums), max = Math.max(...nums);
                        if (min === max) {
                            min = min - 1; max = max + 1;
                        }
                        const padding = (max - min) * 0.1;
                        return [
                            Math.floor(Math.max(minLimit, min - padding)),
                            Math.ceil(Math.min(maxLimit, max + padding))
                        ];
                    }
                    const [tempMin, tempMax] = getMinMax(tempData, 0, 50);
                    const [humiMin, humiMax] = getMinMax(humiData, 0, 100);
                    const [noiseMin, noiseMax] = getMinMax(noiseData, 0, 100);

                    // æ¸©åº¦è¶‹åŠ¿
                    const tempChartInstance = echarts.init(tempChart.value);
                    tempChartInstance.setOption({
                        title: {
                            text: 'æ¸©åº¦è¶‹åŠ¿',
                            left: 'center',
                            top: 10,
                            textStyle: { color: '#cccccc', fontWeight: 'bold', fontSize: 26 }
                        },
                        tooltip: { trigger: 'axis' },
                        grid: { left: 30, right: 16, top: 60, bottom: 24 },
                        xAxis: { type: 'category', data: times, axisLabel: { color: '#666', fontSize: 12 } },
                        yAxis: {
                            type: 'value',
                            axisLabel: { color: '#666', fontSize: 14, formatter: '{value}' },
                            min: tempMin,
                            max: tempMax
                        },
                        series: [{
                            name: 'æ¸©åº¦',
                            type: 'line',
                            data: tempData,
                            smooth: false,
                            symbol: 'circle',
                            symbolSize: 8,
                            lineStyle: { color: '#5470c6', width: 2 },
                            itemStyle: { color: '#5470c6', borderColor: '#fff', borderWidth: 2 },
                            areaStyle: undefined
                        }],
                        graphic: [{
                            type: 'text',
                            left: 10,
                            top: 10,
                            style: {
                                text: 'â„ƒ',
                                fill: '#2d5be3',
                                font: 'bold 18px \\"Noto Sans SC\\",sans-serif'
                            },
                            z: 100
                        }]
                    });
                    // æ¹¿åº¦è¶‹åŠ¿
                    const humiChartInstance = echarts.init(humiChart.value);
                    humiChartInstance.setOption({
                        title: {
                            text: 'æ¹¿åº¦è¶‹åŠ¿',
                            left: 'center',
                            top: 10,
                            textStyle: { color: '#1bbd7e', fontWeight: 'bold', fontSize: 26 }
                        },
                        tooltip: { trigger: 'axis' },
                        grid: { left: 30, right: 16, top: 60, bottom: 24 },
                        xAxis: { type: 'category', data: times, axisLabel: { color: '#666', fontSize: 12 } },
                        yAxis: {
                            type: 'value',
                            axisLabel: { color: '#666', fontSize: 14, formatter: '{value}' },
                            min: humiMin,
                            max: humiMax
                        },
                        series: [{
                            name: 'æ¹¿åº¦',
                            type: 'line',
                            data: humiData,
                            smooth: false,
                            symbol: 'circle',
                            symbolSize: 8,
                            lineStyle: { color: '#91cc75', width: 2 },
                            itemStyle: { color: '#91cc75', borderColor: '#fff', borderWidth: 2 },
                            areaStyle: undefined
                        }],
                        graphic: [{
                            type: 'text',
                            left: 10,
                            top: 10,
                            style: {
                                text: '%',
                                fill: '#1bbd7e',
                                font: 'bold 18px \\"Noto Sans SC\\",sans-serif'
                            },
                            z: 100
                        }]
                    });
                    // å™ªéŸ³è¶‹åŠ¿
                    const noiseChartInstance = echarts.init(noiseChart.value);
                    noiseChartInstance.setOption({
                        title: {
                            text: 'å™ªéŸ³è¶‹åŠ¿',
                            left: 'center',
                            top: 10,
                            textStyle: { color: '#e6a23c', fontWeight: 'bold', fontSize: 26 }
                        },
                        tooltip: { trigger: 'axis' },
                        grid: { left: 30, right: 16, top: 60, bottom: 24 },
                        xAxis: { type: 'category', data: times, axisLabel: { color: '#666', fontSize: 12 } },
                        yAxis: {
                            type: 'value',
                            axisLabel: { color: '#666', fontSize: 14, formatter: '{value}' },
                            min: noiseMin,
                            max: noiseMax
                        },
                        series: [{
                            name: 'å™ªéŸ³',
                            type: 'line',
                            data: noiseData,
                            smooth: false,
                            symbol: 'circle',
                            symbolSize: 8,
                            lineStyle: { color: '#fac858', width: 2 },
                            itemStyle: { color: '#fac858', borderColor: '#fff', borderWidth: 2 },
                            areaStyle: undefined
                        }],
                        graphic: [{
                            type: 'text',
                            left: 10,
                            top: 10,
                            style: {
                                text: 'dBA',
                                fill: '#e6a23c',
                                font: 'bold 18px \\"Noto Sans SC\\",sans-serif'
                            },
                            z: 100
                        }]
                    });
                };

                // è§†é¢‘åŠ è½½æ§åˆ¶ï¼ˆè‡ªåŠ¨éšè—å°é¢ï¼‰
                onMounted(() => {
                    // ä¸»é¢˜ä¸ç²’å­
                    particlesJS.load('particles-js', 'https://cdn.jsdelivr.net/gh/VincentGarreau/particles.js/particles.json');

                    // è§†é¢‘åˆ·æ–°å®šæ—¶å™¨ - æ¯3ç§’åˆ·æ–°ä¸€æ¬¡
                    const cameraTimer = setInterval(refreshCamera, 3000);

                    // åˆå§‹æ¸²æŸ“
                    renderCharts();
                    renderGauges();
                    fetchData();
                    // fetchData æ¯åˆ†é’Ÿè‡ªåŠ¨åˆ·æ–°
                    setInterval(fetchData, 60000);
                    // AIå»ºè®®æ¯1å°æ—¶è‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡
                    setInterval(() => getAISuggestion(data), 3600000);
                });

                // è·å–AIå»ºè®®ï¼Œåˆ†å®¤å†…å’Œå®¤å¤–
                const getAISuggestion = async (envData) => {
                    try {
                        // å®¤å†…å»ºè®®ï¼ˆæœ¬åœ°ä¼ æ„Ÿå™¨æ•°æ®ï¼‰
                        const resIndoor = await axios.post(`${serverUrl}/api/ai_suggestion`, {
                            aqi: envData.aqi,
                            uv_index: envData.uv_index, // ä»…å®¤å†…åˆ†æç”¨
                            temperature: `å®¤å†…æ¸©åº¦${envData.temperature}â„ƒ`,
                            humidity: envData.humidity,
                            noise: envData.noise,
                            eco2: envData.eco2,
                            tvoc: envData.tvoc,
                            type: 'indoor',
                            scene: 'primary_school'
                        });
                        data.suggestionIndoor = resIndoor.data.suggestion || 'æš‚æ— å®¤å†…AIå»ºè®®';
                        data.suggestionIndoorHtml = resIndoor.data.html || resIndoor.data.suggestion || 'æš‚æ— å®¤å†…AIå»ºè®®';

                        // å®¤å¤–å»ºè®®ï¼ˆä¸ä¼ ç´«å¤–çº¿ï¼Œä»…ç”¨æ°”æ¸©/pm2.5/å¤©æ°”/é£å‘ï¼‰
                        const resOutdoor = await axios.post(`${serverUrl}/api/ai_suggestion`, {
                            weather: envData.weather,
                            wind_dir: envData.wind_dir,
                            outdoor_temp: `å®¤å¤–æ¸©åº¦${envData.outdoor_temp}â„ƒ`,
                            pm25: envData.pm25,
                            type: 'outdoor',
                            scene: 'primary_school'
                        });
                        data.suggestionOutdoor = resOutdoor.data.suggestion || 'æš‚æ— å®¤å¤–AIå»ºè®®';
                        data.suggestionOutdoorHtml = resOutdoor.data.html || resOutdoor.data.suggestion || 'æš‚æ— å®¤å¤–AIå»ºè®®';
                    } catch (e) {
                        console.error('AIå»ºè®®è·å–å¤±è´¥:', e);
                        data.suggestionIndoor = 'å®¤å†…AIå»ºè®®è·å–å¤±è´¥';
                        data.suggestionIndoorHtml = 'å®¤å†…AIå»ºè®®è·å–å¤±è´¥';
                        data.suggestionOutdoor = 'å®¤å¤–AIå»ºè®®è·å–å¤±è´¥';
                        data.suggestionOutdoorHtml = 'å®¤å¤–AIå»ºè®®è·å–å¤±è´¥';
                    }
                };

                // æ‰‹åŠ¨åˆ·æ–°AIå»ºè®®
                const refreshAISuggestion = async () => {
                    if (aiRefreshing.value) return; // é˜²æ­¢é‡å¤ç‚¹å‡»

                    aiRefreshing.value = true;
                    console.log('æ‰‹åŠ¨åˆ·æ–°AIå»ºè®®...');

                    try {
                        // å…ˆæ˜¾ç¤ºåŠ è½½çŠ¶æ€
                        data.suggestionIndoor = 'æ­£åœ¨æ›´æ–°å®¤å†…AIå»ºè®®...';
                        data.suggestionIndoorHtml = 'æ­£åœ¨æ›´æ–°å®¤å†…AIå»ºè®®...';
                        data.suggestionOutdoor = 'æ­£åœ¨æ›´æ–°å®¤å¤–AIå»ºè®®...';
                        data.suggestionOutdoorHtml = 'æ­£åœ¨æ›´æ–°å®¤å¤–AIå»ºè®®...';

                        // è°ƒç”¨AIå»ºè®®è·å–å‡½æ•°
                        await getAISuggestion(data);

                        console.log('AIå»ºè®®æ‰‹åŠ¨åˆ·æ–°å®Œæˆ');
                    } catch (error) {
                        console.error('æ‰‹åŠ¨åˆ·æ–°AIå»ºè®®å¤±è´¥:', error);
                        data.suggestionIndoor = 'AIå»ºè®®åˆ·æ–°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
                        data.suggestionIndoorHtml = 'AIå»ºè®®åˆ·æ–°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
                        data.suggestionOutdoor = 'AIå»ºè®®åˆ·æ–°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
                        data.suggestionOutdoorHtml = 'AIå»ºè®®åˆ·æ–°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
                    } finally {
                        aiRefreshing.value = false;
                    }
                };

                const fetchData = async () => {
                    console.log('æ­£åœ¨è·å–æ•°æ®...');
                    try {
                        const res = await axios.get(`${serverUrl}/data`, { timeout: 3000 });
                        console.log('åç«¯æ•°æ®', res.data);
                        const safeData = Object.assign({
                            weather: 'æš‚æ— ',
                            wind_dir: '-',
                            temperature: '-',
                            humidity: '-',
                            aqi: 0,
                            eco2: '-',
                            tvoc: '-',
                            uv_raw: '-',
                            uv_index: 0,
                            noise: '-',
                            camera: '',
                            suggestion: 'è·å–ä¸­...',
                            suggestionHtml: '',
                            outdoor_temp: '-',
                            pm25: '-'
                        }, res.data);
                        console.log('safeData', safeData);
                        Object.assign(data, {
                            // ä¿è¯æ‰€æœ‰æ•°æ®éƒ½ä¸ºæ•´æ•°ï¼ˆæˆ–å­—ç¬¦ä¸²'--'ï¼‰
                            temperature: formatDataValue(safeData.temperature),
                            humidity: formatDataValue(safeData.humidity),
                            aqi: formatDataValue(safeData.aqi),
                            eco2: formatDataValue(safeData.eco2),
                            tvoc: formatDataValue(safeData.tvoc),
                            uv_raw: formatDataValue(safeData.uv_raw),
                            uv_index: formatDataValue(safeData.uv_index),
                            noise: formatDataValue(safeData.noise),
                            camera: safeData.camera,
                            suggestion: safeData.suggestion,
                            weather: safeData.weather || 'æš‚æ— ',
                            wind_dir: safeData.wind_dir || '-',
                            outdoor_temp: formatDataValue(safeData.outdoor_temp),
                            pm25: formatDataValue(safeData.pm25)
                        });

                        // å½“æ‘„åƒå¤´æ•°æ®æ›´æ–°æ—¶ï¼Œæ›´æ–°æ—¶é—´æˆ³ä»¥å¼ºåˆ¶é‡æ–°æ¸²æŸ“
                        if (safeData.camera) {
                            refreshTimestamp.value = Date.now();
                            console.log('æ‘„åƒå¤´æ•°æ®æ›´æ–°ï¼Œåˆ·æ–°æ—¶é—´æˆ³:', refreshTimestamp.value);
                        }
                        // å†è¯·æ±‚OpenWeather
                        const weatherUrl = `https://api.openweathermap.org/data/2.5/weather?q=tianshui&appid=242a27eb0e3a75518de493b5df62f296&lang=zh_cn&units=metric`;
                        axios.get(weatherUrl).then(wres => {
                            console.log('openweather', wres.data);
                            data.weather = wres.data.weather[0].description;
                            // é£å‘
                            data.wind_dir = windDegToDirection(wres.data.wind.deg);
                            data.outdoor_temp = wres.data.main.temp;
                            // è·å–PM2.5ï¼ˆéœ€ç”¨ç©ºæ°”æ±¡æŸ“æ¥å£ï¼‰
                            const lat = wres.data.coord.lat;
                            const lon = wres.data.coord.lon;
                            const airUrl = `https://api.openweathermap.org/data/2.5/air_pollution?lat=${lat}&lon=${lon}&appid=242a27eb0e3a75518de493b5df62f296`;
                            axios.get(airUrl).then(ares => {
                                console.log('air', ares.data);
                                if (ares.data && ares.data.list && ares.data.list[0] && ares.data.list[0].components) {
                                    data.pm25 = ares.data.list[0].components.pm2_5;
                                } else {
                                    data.pm25 = '--';
                                }
                            }).catch(e => {
                                console.error('airæ¥å£å¼‚å¸¸', e);
                                data.pm25 = '--';
                            }).finally(() => {
                                // ä¿è¯pm2.5æ•°æ®å·²æ›´æ–°åå†è·å–AIå»ºè®®
                                mqttStatus.value = 'å·²è¿æ¥';
                                Vue.nextTick().then(() => {
                                    renderGauges();
                                    renderCharts();
                                    // ä¿®æ­£ï¼šç´«å¤–çº¿æŒ‡æ•°å–æ•´
                                    if (typeof data.uv_raw === 'number' || (typeof data.uv_raw === 'string' && !isNaN(Number(data.uv_raw)))) {
                                        data.uv_raw = Math.round(Number(data.uv_raw));
                                    }
                                    if (typeof data.uv_index === 'number' || (typeof data.uv_index === 'string' && !isNaN(Number(data.uv_index)))) {
                                        data.uv_index = Math.round(Number(data.uv_index));
                                    }
                                    getAISuggestion(data);
                                });
                            });
                        }).catch(e => {
                            console.error('openweatheræ¥å£å¼‚å¸¸', e);
                            // ä¿æŒåŸæœ‰weather/wind_dir/outdoor_temp/pm25
                            data.outdoor_temp = '--'; // ä¿®æ­£ï¼šæ¥å£å¼‚å¸¸æ—¶ä¸æ˜¾ç¤º0â„ƒ
                            mqttStatus.value = 'å·²è¿æ¥';
                            Vue.nextTick().then(() => {
                                renderGauges();
                                renderCharts();
                                getAISuggestion(data);
                            });
                        });
                    } catch (e) {
                        console.error('fetchData error', e);
                        mqttStatus.value = 'æœªè¿æ¥ï¼ˆæ¨¡æ‹Ÿæ•°æ®ï¼‰';
                        Object.assign(data, {
                            tvoc: 100 + Math.floor(Math.random() * 100),
                            // åªåœ¨æ¨¡æ‹Ÿæ•°æ®æ—¶æ‰ç”¨éšæœºç´«å¤–çº¿æŒ‡æ•°
                            uv_raw: Math.floor(Math.random() * 3),
                            uv_index: Math.floor(Math.random() * 3),
                            noise: (45 + Math.random() * 10).toFixed(1),
                            camera: '',
                            suggestion: 'æ¨¡æ‹Ÿæ•°æ®',
                            weather: 'æ™´',
                            wind_dir: 'ä¸œ',
                            outdoor_temp: (Math.random() * 35).toFixed(1),
                            pm25: Math.floor(Math.random() * 150)
                        });
                        await Vue.nextTick();
                        renderGauges();
                        renderCharts();
                        // æ¯æ¬¡éƒ½è·å–AIå»ºè®®ï¼ˆæ¨¡æ‹Ÿæ•°æ®ï¼‰
                        getAISuggestion(data);
                    }
                };
                // é£å‘è½¬æ¢å‡½æ•°
                function windDegToDirection(deg) {
                    if (typeof deg !== 'number' || isNaN(deg)) return '--';
                    const dirs = ['åŒ—', 'ä¸œåŒ—', 'ä¸œ', 'ä¸œå—', 'å—', 'è¥¿å—', 'è¥¿', 'è¥¿åŒ—'];
                    return dirs[Math.round(deg / 45) % 8];
                }

                // Element Pluså›¾æ ‡å¼•ç”¨
                const CircleCheckFilled = ElementPlusIconsVue?.CircleCheckFilled || 'CircleCheckFilled';
                const WarningFilled = ElementPlusIconsVue?.WarningFilled || 'WarningFilled';
                const Loading = ElementPlusIconsVue?.Loading || 'Loading';
                const Setting = ElementPlusIconsVue?.Setting || 'Setting';
                const Refresh = ElementPlusIconsVue?.Refresh || 'Refresh';

                // æ•°æ®æ ¼å¼åŒ–è¾…åŠ©å‡½æ•°
                function formatDataValue(v) {
                    if (v === '-' || v === undefined || v === null || v === '' || isNaN(Number(v))) {
                        return '--';
                    }
                    const num = Number(v);
                    return isNaN(num) ? '--' : Math.round(num);
                }

                // ä¿è¯æ‰€æœ‰ç¯å¢ƒæ•°æ®æ˜¾ç¤ºä¸ºæ•´æ•°
                function formatInt(v) {
                    if (v === '-' || v === undefined || v === null || isNaN(Number(v))) return '--';
                    return parseInt(Number(v));
                }

                // æ·»åŠ æ‘„åƒå¤´URLçŠ¶æ€ç®¡ç†
                const cameraUrlWithTimestamp = Vue.computed(() => {
                    if (!data.camera) return '';

                    // å¦‚æœæ˜¯base64å›¾ç‰‡ï¼Œä¸ºäº†å¼ºåˆ¶æ›´æ–°ï¼Œæ·»åŠ æ—¶é—´æˆ³ä½œä¸ºå‚æ•°ï¼ˆè™½ç„¶æ— æ•ˆï¼Œä½†å¯ä»¥è§¦å‘Vueå“åº”å¼æ›´æ–°ï¼‰
                    if (data.camera.startsWith('data:image')) {
                        // æ¯æ¬¡æ—¶é—´æˆ³æ›´æ–°æ—¶ï¼Œé‡æ–°è·å–æœ€æ–°çš„base64æ•°æ®
                        const timestamp = refreshTimestamp.value; // è¿™é‡Œå¼•ç”¨æ—¶é—´æˆ³ä»¥è§¦å‘å“åº”å¼æ›´æ–°
                        return data.camera;
                    }

                    // å¦‚æœæ˜¯HTTPå›¾ç‰‡URLï¼Œæ·»åŠ æ—¶é—´æˆ³é˜²æ­¢ç¼“å­˜
                    if (data.camera.startsWith('http') && /\.(jpg|jpeg|png|gif)(\?.*)?$/i.test(data.camera)) {
                        const base = data.camera.split('?')[0];
                        const timestamp = refreshTimestamp.value;
                        return `${base}?t=${timestamp}`;
                    }

                    return data.camera;
                });

                // æ·»åŠ åˆ·æ–°æ—¶é—´æˆ³
                const refreshTimestamp = ref(Date.now());

                // è§†é¢‘åŠ è½½çŠ¶æ€
                const videoLoadState = ref('loading');

                // é”™è¯¯å¤„ç†å‡½æ•°
                const handleVideoError = () => {
                    console.log('è§†é¢‘æµåŠ è½½å¤±è´¥');
                    videoLoadState.value = 'error';
                };

                const handleVideoLoad = () => {
                    console.log('è§†é¢‘æµåŠ è½½æˆåŠŸ');
                    videoLoadState.value = 'loaded';
                };

                const handleImageError = () => {
                    console.log('å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œå°è¯•åˆ·æ–°...');
                    // å»¶è¿Ÿé‡è¯•
                    setTimeout(() => {
                        refreshTimestamp.value = Date.now();
                    }, 2000);
                };

                const handleImageLoad = () => {
                    console.log('å›¾ç‰‡åŠ è½½æˆåŠŸ');
                    videoLoadState.value = 'loaded';
                };

                // ä¿®æ”¹ç°æœ‰çš„refreshCameraå‡½æ•°
                const refreshCamera = () => {
                    // å¯¹äºæ‰€æœ‰ç±»å‹çš„å›¾ç‰‡éƒ½å¼ºåˆ¶åˆ·æ–°æ—¶é—´æˆ³
                    refreshTimestamp.value = Date.now();
                    console.log('æ‘„åƒå¤´åˆ·æ–°æ—¶é—´æˆ³æ›´æ–°:', refreshTimestamp.value);
                };

                // æœåŠ¡å™¨é…ç½®ç›¸å…³
                const showServerConfig = ref(false);
                const currentServerUrl = ref(serverUrl);
                const serverConfigForm = ref({
                    serverIp: ''
                });

                const saveServerConfig = () => {
                    const newIp = serverConfigForm.value.serverIp.trim();
                    if (newIp) {
                        localStorage.setItem('env-monitor-server', newIp);
                        const newUrl = `http://${newIp}:5052`;
                        console.log('ä¿å­˜æ–°çš„æœåŠ¡å™¨åœ°å€:', newUrl);
                    } else {
                        localStorage.removeItem('env-monitor-server');
                        console.log('æ¸…é™¤è‡ªå®šä¹‰æœåŠ¡å™¨åœ°å€ï¼Œä½¿ç”¨é»˜è®¤é…ç½®');
                    }
                    showServerConfig.value = false;
                    // é‡æ–°åŠ è½½é¡µé¢ä»¥åº”ç”¨æ–°é…ç½®
                    window.location.reload();
                };

                // è¿”å›æ–°å¢çš„å“åº”å¼å˜é‡
                return {
                    data, now, dateStr, tempChart, humiChart, noiseChart, aqiGauge, uvGauge, eco2Gauge, tvocGauge, aqiLevelText, uvLevelText, eco2LevelText, tvocLevelText, mqttStatus, CircleCheckFilled, WarningFilled, Loading, Setting, Refresh, formatInt,
                    cameraUrlWithTimestamp,
                    refreshTimestamp,
                    videoLoadState,
                    handleVideoError,
                    handleVideoLoad,
                    handleImageError,
                    handleImageLoad,
                    showServerConfig,
                    currentServerUrl,
                    serverConfigForm,
                    saveServerConfig,
                    aiRefreshing,
                    refreshAISuggestion
                };
            }
        })
            .use(ElementPlus)
            .mount('#app');
    </script>

</body>

</html>