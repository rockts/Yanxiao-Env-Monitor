# 烟铺小学智慧校园环境监测系统

## 项目概述

烟铺小学智慧校园环境监测系统是一个大屏展示项目，实时监控并展示校园环境数据，包括温度、湿度、空气质量、噪音、天气以及实时摄像头监控画面等。该系统通过 MQTT 协议接收各传感器数据，以直观的界面呈现给用户。

## 快速启动

### 完整版（推荐）

双击 `run_full_dashboard.command` 文件启动完整版系统，包含所有功能：

- 传感器数据监测
- 视频监控
- 数据记录
- 阈值警告
- 历史数据查看

### 简单版

如果只需要基本功能，可以双击 `simple_working_dashboard.command` 文件启动简单版系统。

### 直接启动（所有系统）

运行以下命令启动完整版系统：

```bash
python3 full_dashboard_new.py
```

或运行简单版：

```bash
python3 simple_working_dashboard.py
```

## 最新更新 (2025年5月22日)

系统已完成以下重要更新：

- **完整版仪表盘**：更全面的功能和优化的用户体验
- **基于配置文件的设置**：所有系统参数都可以通过配置文件自定义
- **数据记录与回溯**：支持传感器数据记录和历史数据查看
- **智能阈值警告**：根据配置的阈值显示警告状态
- **文件整理与组织**：更清晰的项目结构，便于维护
- **强化的视频支持**：更大、更清晰的视频显示，支持多种格式
- **增强的错误处理**：更好的连接恢复和错误管理

## 系统功能

### 核心功能

- **实时数据监测**：显示环境温度、湿度、AQI空气质量指数、eCO2、TVOC、紫外线指数、噪音等数据
- **智能连接管理**：自动连接MQTT服务器，连接失败时自动切换到模拟数据模式
- **状态指示与警告**：根据阈值直观显示各环境参数的安全状态
- **视频监控**：实时显示校园监控画面，支持多种视频格式

### 高级功能

- **数据记录**：自动记录传感器数据，便于后续分析
- **历史数据查看**：点击传感器面板可查看历史数据趋势
- **可配置阈值**：为每种传感器设置警告和危险阈值
- **视觉反馈**：超过阈值时提供醒目的颜色警告
- **数据清理**：自动管理和清理旧数据

## 项目结构

```
dashboard/
├── full_dashboard_new.py     # 完整版仪表盘主程序
├── simple_working_dashboard.py # 简单版仪表盘
├── run_full_dashboard.command # 完整版启动脚本 (macOS)
├── simple_working_dashboard.command # 简单版启动脚本 (macOS)
├── start_dashboard.command   # 智能启动脚本 (macOS)
├── dashboard.py             # 符号链接到完整版
├── requirements.txt         # 依赖列表
├── README.md               # 项目说明文档
├── config/                 # 配置文件目录
│   └── default_config.json # 默认配置文件
├── data/                   # 数据文件目录
│   └── sensor_logs/        # 传感器数据日志
├── logs/                   # 系统日志目录
├── src/                    # 源代码模块
│   ├── config_loader.py    # 配置加载模块
│   ├── data_logger.py      # 数据记录模块
│   └── alert_manager.py    # 警报管理模块
├── utils/                  # 工具脚本
│   ├── clean_data.py       # 数据清理工具
│   └── clean_data.command  # 数据清理启动脚本
├── docs/                   # 文档
└── archive/                # 存档文件
```

## 配置文件说明

系统使用JSON格式的配置文件 (`config/default_config.json`)，主要配置项包括：

- **MQTT设置**：服务器地址、端口、用户名、密码、订阅主题
- **UI设置**：窗口标题、大小、颜色方案
- **传感器配置**：显示名称、单位、图标、警告阈值
- **视频设置**：尺寸、帧率、标题
- **数据记录设置**：启用状态、记录间隔、保留天数

## MQTT 主题结构

系统通过以下 MQTT 主题接收数据：

| 主题              | 描述               | 数据格式         |
| ----------------- | ------------------ | ---------------- |
| `siot/环境温度`   | 环境温度数据       | 数值（°C）       |
| `siot/环境湿度`   | 环境湿度数据       | 数值（%RH）      |
| `siot/aqi`        | 空气质量指数       | 数值             |
| `siot/tvoc`       | 总挥发性有机化合物 | 数值（ppb）      |
| `siot/eco2`       | 等效二氧化碳浓度   | 数值（ppm）      |
| `siot/紫外线指数` | 紫外线强度指数     | 数值             |
| `siot/uv风险等级` | 紫外线风险等级     | 文本（低/中/高） |
| `siot/噪音`       | 噪音水平           | 数值（dB）       |
| `siot/摄像头`     | 摄像头画面流       | Base64 编码图像  |

## 注意事项

1. 首次运行时，系统会尝试连接 MQTT 服务器，如果连接失败，将自动切换到模拟数据模式
2. 如需修改 MQTT 连接设置，请编辑 `simple_working_dashboard.py` 文件中的配置部分
3. 系统日志保存在 `logs/` 目录下，可用于排查问题

## 技术支持

如有任何问题或需要技术支持，请参阅 `修复报告.md` 文件或联系系统管理员。

---

_最后更新：2025 年 5 月 22 日_

- **摄像头监控**：实时显示校园监控画面
- **天气信息**：通过第三方 API 获取并展示当前天气状况、风速等信息
- **智能建议**：基于监测数据提供环境改善的智能建议
- **模拟模式**：在无传感器或测试环境中，可启用模拟数据模式

## 系统组件

### 1. Python 仪表盘

- 负责数据处理、MQTT 通信和基础数据显示
- 基于 Python 和 Tkinter 构建

### 2. Mind+大屏

- 负责数据可视化和美观界面展示
- 基于 Mind+平台构建的大屏显示文件
- 文件位置：`data/烟小智慧环境监测物联网大屏.mpdb`（Mind+项目文件）

## 系统要求

- Python 3.8 或更高版本
- 依赖库：
  - paho-mqtt：MQTT 通信
  - Pillow (PIL)：图像处理
  - matplotlib：数据可视化图表
  - tkinter：UI 界面（Python 标准库）
  - requests：API 网络请求
- Mind+软件（用于运行大屏文件）

## 安装与运行

1. **安装依赖**：

   ```bash
   pip install paho-mqtt Pillow matplotlib requests
   ```

2. **运行方式**：

   - **超级简单版**（强烈推荐）：

   ```bash
   # 方法1: macOS用户双击此文件
   一键启动.command

   # 方法2: 直接运行Python脚本
   python3 超级简单版仪表盘.py
   ```

   - 使用优化启动器：

   ```bash
   python launch_dashboard.py
   ```

   - 使用简单启动器：

   ```bash
   python run_simple_dashboard.py
   ```

   - macOS 用户可直接双击：

   ```
   启动仪表盘.command
   ```

   - macOS 专用脚本(解决 GUI 显示问题)：

   ```bash
   ./run_dashboard_macos.sh
   ```

3. **配置修复工具**：

   如果遇到配置文件错误，请运行：

   ```bash
   python fix_config.py
   ```

> 更多详细信息请参考 [启动指南](STARTUP_GUIDE.md)

     ```bash
     ./easy_start.py
     ```

- 使用统一启动器（支持更多选项）：

  ```bash
  ./launch.py [选项]
  ```

  支持的选项：

  - `--debug`：启用调试模式
  - `--simple`：启动简易仪表盘
  - `--mqtt-server=<地址>`：指定 MQTT 服务器地址
  - `--mqtt-port=<端口号>`：指定 MQTT 服务器端口
  - `--config=<配置文件路径>`：指定配置文件路径

- 使用脚本（适用于不同系统）：

  ```bash
  # macOS 或 Linux
  ./scripts/unix/start_dashboard.command

  # Windows
  scripts\windows\start_dashboard_windows.bat
  ```

- 直接运行主程序：
  ```bash
  python src/main_dashboard.py
  ```

3. **测试数据模拟**：
   如果没有真实传感器数据，可使用内置的数据模拟功能：

   ```bash
   # 使用统一启动器的模拟模式
   ./launch.py --simulator

   # 或直接运行模拟器
   python src/simulators/sensor_data_simulator.py
   ```

## MQTT 主题结构

系统通过以下 MQTT 主题接收数据：

| 主题               | 描述               | 数据格式                                     |
| ------------------ | ------------------ | -------------------------------------------- |
| `siot/环境温度`    | 环境温度数据       | 数值（°C）                                   |
| `siot/环境湿度`    | 环境湿度数据       | 数值（%RH）                                  |
| `siot/aqi`         | 空气质量指数       | 数值                                         |
| `siot/tvoc`        | 总挥发性有机化合物 | 数值（ppb）                                  |
| `siot/eco2`        | 等效二氧化碳浓度   | 数值（ppm）                                  |
| `siot/紫外线指数`  | 紫外线强度指数     | 数值                                         |
| `siot/uv风险等级`  | 紫外线风险等级     | 文本（低/中/高）                             |
| `siot/噪音`        | 噪音水平           | 数值（dB）                                   |
| `sc/camera/stream` | 摄像头画面流       | Base64 编码图像或 JSON 对象（含 image 字段） |
| `sc/weather/data`  | 天气数据           | JSON 对象                                    |

### 数据格式示例

- **传感器数据**：直接发送数值或字符串，如 `"25.6"` 或 `"低"`
- **摄像头数据**：
  ```json
  {
   "image": "base64编码的图像数据..."
  }
  ```
- **天气数据**：
  ```json
  {
   "weather": [{ "description": "晴天", "icon": "01d" }],
   "main": {
    "temp": 25.6,
    "humidity": 65
   },
   "wind": {
    "speed": 3.1
   }
  }
  ```

## 调试与故障排除

- **MQTT 连接失败**：

  - 检查 MQTT 服务器是否正常运行
  - 验证用户名密码配置（默认：siot/dfrobot）
  - 确认网络连接状态和防火墙设置

- **图像显示问题**：

  - 确保已正确安装 Pillow 库
  - 检查相机主题数据是否为有效的 Base64 编码图像

- **图表不显示**：
  - 确保已安装 matplotlib
  - 检查数据格式是否正确（应为数值）

## 开发者信息

- 版本：v1.2.0
- 最后更新：2025 年 5 月 19 日

## 数据图表功能

系统提供三种实时更新的数据图表：

- **温度图表**：显示过去时间段内的温度变化趋势，以摄氏度为单位
- **湿度图表**：显示过去时间段内的湿度变化趋势，以相对湿度百分比为单位
- **噪音图表**：显示过去时间段内的噪音水平变化，以分贝为单位

图表特性：

- 时间轴自动调整，显示最近的数据点
- Y 轴会根据数据范围动态调整，确保数据变化明显可见
- 每 5 分钟标记一个时间点
- 数据点最多保存 60 个点的历史记录

## 系统架构

![系统架构图](../screenshots/dashboard_concept.png)

### 核心组件：

1. **MQTT 数据接收器**：订阅多个话题，实时接收传感器数据
2. **数据处理模块**：解析、验证和转换各类传感器数据
3. **图形用户界面**：基于 Tkinter 的大屏显示界面
4. **数据可视化**：实时更新的图表和数值显示
5. **AI 智能建议**：根据环境数据提供智能建议
6. **测试数据生成器**：可独立运行的测试数据模拟模块

## 定制与扩展

### 添加新传感器：

1. 在 `MQTT_TOPICS` 中添加新的 MQTT 主题
2. 在 `update_sensor_data` 方法中添加对应的处理逻辑
3. 创建相应的界面组件显示新数据

### 自定义界面：

- 通过修改 UI 常量部分可调整颜色、大小等界面元素
- 可以在 `create_header` 和 `create_panels` 方法中添加新的界面组件

---

_备注：系统同时支持真实数据和模拟数据，适用于实际生产环境和演示环境。智能环境建议算法可根据学校需求进一步定制。_
